# Morgan Stanley at Work Integration

## Overview

Morgan Stanley at Work is an employee stock plan platform. This integration uses their internal GraphQL API to fetch portfolio data.

## Authentication Architecture

Morgan Stanley uses a complex authentication system with multiple IDs that are easily confused:

### Key IDs (IMPORTANT - These are DIFFERENT values!)

| ID Type | Example Value | Where Found | Purpose |
|---------|---------------|-------------|---------|
| `employeePK` | `37493646648` | Dashboard HTML `SW.initialData.activeAccount.employeePK` | **Used as `employeeid` header in GraphQL requests** |
| `accountPK` | `37498936179` | Dashboard HTML `SW.initialData.activeAccount.accountPK` | Same as JWT `sub` claim - NOT used for GraphQL! |
| JWT `sub` claim | `37498936179` | JWT payload | Identifies the account, but NOT the employee ID header |

**CRITICAL**: The `employeeid` header required for GraphQL is `employeePK`, NOT the JWT's `sub` claim. Using the wrong value causes 500 Internal Server Error.

## API Endpoints

### GraphQL Endpoint
- URL: `https://atwork.morganstanley.com/graphql`
- Method: POST
- Required Headers:
  - `authorization`: JWT token (without "Bearer " prefix)
  - `employeeid`: The `employeePK` value (NOT JWT sub!)
  - `content-type`: application/json

### Login Endpoint
- URL: `https://atwork.morganstanley.com/solium/servlet/userLogin.do`
- Method: POST
- Content-Type: `application/x-www-form-urlencoded`
- Redirects to: `/solium/servlet/ui` on success

### Dashboard Page
- URL: `https://atwork.morganstanley.com/solium/servlet/ui`
- Contains: `SW.initialData` JavaScript object with all user/account data
- Key data in `SW.initialData.activeAccount`:
  - `employeePK`: Required for GraphQL `employeeid` header
  - `accountPK`: Same as JWT `sub` claim
  - `userPK`: User primary key
  - `employeeFullName`, `companyName`, etc.

## Working GraphQL Query

```graphql
query {
  portfolio {
    availableValue { amount currency }
    unavailableValue { amount currency }
    totalValue { amount currency }
  }
}
```

### Available GraphQL Queries (from schema introspection)
- `aggregatePortfolio`
- `currencyRates`
- `aggregateRelease`
- `company`
- `events`
- `portfolio`
- `portfolioModelling`
- `funds`
- `transactions`
- `offering`
- `grantElections`
- `retailAccount`
- `enrollments`
- `enrollmentDetails`
- `sellSharesInitialData`
- `participantDetails`

## Authentication Methods

### Method 1: Username + Password (Preferred)
1. POST login credentials to `/solium/servlet/userLogin.do`
2. Follow redirect to `/solium/servlet/ui`
3. Extract `employeePK` from `SW.initialData.activeAccount.employeePK`
4. **Problem**: JWT token is generated by frontend JavaScript, not returned in login response
5. **Result**: Login may succeed, but JWT still needs to be provided manually

### Method 2: JWT + Employee ID (Fallback)
1. User logs in via browser
2. Opens DevTools > Network > filters by "graphql"
3. Copies `authorization` header value (JWT token)
4. Copies `employeeid` header value (this is `employeePK`)
5. Provides both to the integration

## Bot Detection

Morgan Stanley has strong bot detection (Akamai). The integration uses `curl_cffi` with Chrome TLS fingerprint impersonation to help bypass it:

```python
from curl_cffi import requests as curl_requests
session = curl_requests.Session(impersonate="chrome")
```

Login may still fail due to bot detection. In that case, users must use Method 2 (JWT + Employee ID).

## Example Working Request

```bash
curl 'https://atwork.morganstanley.com/graphql' \
  -H 'authorization: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...' \
  -H 'employeeid: 37493646648' \
  -H 'content-type: application/json' \
  --data-raw '{"operationName":null,"variables":{},"query":"{ portfolio { availableValue { amount currency } } }"}'
```

## Response Format

```json
{
  "data": {
    "portfolio": {
      "availableValue": {
        "amount": "244380.1",
        "currency": "USD"
      },
      "unavailableValue": {
        "amount": "301855.10852",
        "currency": "USD"
      },
      "totalValue": {
        "amount": "546235.20852",
        "currency": "USD"
      }
    }
  }
}
```

- `availableValue`: Vested shares (can be sold)
- `unavailableValue`: Unvested shares (still vesting)
- `totalValue`: Sum of both

## Common Errors

### 500 Internal Server Error on portfolio queries
**Cause**: Wrong `employeeid` header value (using JWT `sub` instead of `employeePK`)
**Solution**: Use `employeePK` from dashboard HTML, not JWT payload

### 400 Bad Request
**Cause**: Missing `employeeid` header
**Solution**: Provide the `employeeid` header

### "invalid token signature"
**Cause**: JWT token expired (tokens last ~1 hour)
**Solution**: Get fresh JWT from browser DevTools

## Implementation Files

- Integration: `backend/brokers/integrations/morganstanley.py`
- Fixtures: `backend/brokers/fixtures/initial_brokers.json`
- Factory: `backend/brokers/integrations/__init__.py`

## Credential Schema

```json
{
  "type": "object",
  "required": ["username", "password"],
  "properties": {
    "username": { "type": "string", "title": "Username" },
    "password": { "type": "string", "title": "Password", "format": "password" },
    "jwt_token": { "type": "string", "title": "JWT Token (if login fails)", "format": "password" },
    "employee_id": { "type": "string", "title": "Employee ID (if login fails)" }
  }
}
```

## Investigation History (2026-01-30)

1. Initial problem: GraphQL queries returning 500 errors
2. Found that JWT authentication was working (schema introspection succeeded)
3. Discovered `employeeid` header value in working curl example was different from JWT `sub`
4. Tested with correct `employeeid` (from header, not JWT) - worked!
5. Analyzed HAR/dashboard HTML to find source of `employeeid`
6. Found `employeePK` in `SW.initialData.activeAccount` - this is the correct value
7. Updated integration to extract `employeePK` from dashboard after login
8. Updated credential schema to support both auth methods

## Key Learnings

1. **JWT `sub` is NOT the employee ID** - this was the main bug
2. `employeePK` and `accountPK` are different values for the same user
3. The frontend JavaScript generates/retrieves JWT - it's not in login response
4. Bot detection may block programmatic login, requiring manual JWT extraction
5. Headers must be lowercase (`authorization`, `employeeid`)
6. JWT should NOT have "Bearer " prefix when sent to Morgan Stanley

## JWT Token Investigation (2026-01-30)

### The Problem
The JWT token required for GraphQL calls is NOT returned in the login response. After successful login with username/password, we can extract `employeePK` from the dashboard HTML, but the JWT must still be provided manually.

### Investigation Attempts

We tried multiple approaches to obtain the JWT programmatically:

1. **Token endpoints tested** (all failed to return JWT):
   - `/solium/api/auth/token`
   - `/solium/api/session/token`
   - `/solium/servlet/mobileAuth.do`
   - `/solium/servlet/getToken.do`
   - `/api/auth/token`
   - `/oauth/token`

2. **GraphQL mutations tested**:
   - `{ getToken { token } }` - Query doesn't exist
   - `mutation { login { token } }` - Mutation doesn't exist
   - `{ session { token } }` - Query doesn't exist
   - Schema introspection shows no auth-related queries/mutations

3. **Dashboard analysis**:
   - `SW.initialData` contains `apiKey` which matches JWT's `ses` claim
   - No JWT or token field found in `SW.initialData`
   - JWT not found embedded anywhere in dashboard HTML

### Conclusion

The JWT is generated by frontend JavaScript in a way we haven't been able to replicate:
- JWT uses RS256 (RSA signature), so it MUST be generated server-side
- The frontend likely calls an internal API that we couldn't identify
- Possible mechanisms: WebSocket, encrypted endpoint, or dynamic JS-based auth

### Current Workaround

Users must provide JWT + Employee ID manually from browser DevTools:

1. Log into Morgan Stanley at Work in browser
2. Open DevTools (F12 or Cmd+Option+I)
3. Go to Network tab
4. Navigate to any page that loads portfolio data (or refresh)
5. Filter by "graphql"
6. Click on any graphql request
7. In the Headers section, copy:
   - `authorization` header value → JWT Token
   - `employeeid` header value → Employee ID

**Note**: JWT tokens expire after ~1 hour. Users will need to refresh credentials periodically.

### Future Improvements

To fully automate this, we would need to:
1. Reverse-engineer the frontend JavaScript bundle to find token generation
2. Check for WebSocket messages that might deliver the token
3. Monitor all XHR requests after page load to find the token endpoint
4. Consider using browser automation (Playwright/Puppeteer) to extract the token

Using browser automation would be more reliable but adds significant complexity.
